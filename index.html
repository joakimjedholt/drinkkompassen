<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drinkkompassen ‚Äì Klustrad layout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F7FAFF; --text:#1F2937; --muted:#6B7280;
      --card:#FFFFFF; --accent:#2563EB; --highlight:#93C5FD;
      --edge:#94A3B8; --edge-hi:#60A5FA;
      --radius:12px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;padding:1rem;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
    h1{margin:0 0 .75rem;text-align:center;font-weight:700;font-size:2rem}
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    #top{max-width:1200px;margin:0 auto 1rem;padding:.5rem}
    #row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    #search{flex:1;border:none;outline:none;padding:.8rem 1rem;font-size:1rem;background:#F8FAFC;border-radius:10px}
    select,button{border:none;border-radius:10px;padding:.6rem .8rem;font-size:.95rem}
    #apply,#reset{background:var(--accent);color:#fff;box-shadow:var(--shadow);cursor:pointer}
    #apply:hover,#reset:hover{transform:translateY(-1px)}
    #graph{height:720px;max-width:1200px;margin:0 auto 1rem}
    #graph.panel{padding:.25rem}
    #list.panel{max-width:1200px;margin:0 auto}
    #meta{padding:.6rem .8rem;color:var(--muted)}
    #drink-list{max-height:150px;overflow:auto;padding:.25rem .5rem .75rem}
    .drink-item{padding:.4rem .5rem;border-bottom:1px solid #E5E7EB;cursor:pointer}
    .drink-item:hover{background:#EFF6FF}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50}
    .modal-card{width:min(560px,92vw);background:var(--card);border-radius:16px;margin:8vh auto 0;padding:1rem 1.25rem 1.25rem;box-shadow:var(--shadow)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    .modal-title{margin:.25rem 0 .75rem;font-size:1.4rem;font-weight:700}
    .close{font-size:1.6rem;cursor:pointer;line-height:1;padding:.25rem .5rem;color:var(--muted)}
    .grid-2{display:grid;grid-template-columns:1fr;gap:.5rem}
    @media(min-width:580px){.grid-2{grid-template-columns:1fr 1fr}}
    ul{margin:.25rem 0;padding-left:1.1rem}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
  <h1>üç∏ Drinkkompassen ‚Äì Klustrad layout</h1>

  <section id="top" class="panel">
    <div id="row">
      <input id="search" type="text" placeholder="S√∂k efter drink eller ingrediens‚Ä¶">
      <select id="group-by" title="Klustring">
        <option value="kategori">Gruppera efter kategori</option>
        <option value="sprit">Gruppera efter sprit</option>
      </select>
      <button id="apply">Anv√§nd layout</button>
      <button id="reset">√Öterst√§ll</button>
    </div>
  </section>

  <section id="graph" class="panel"></section>

  <section id="list" class="panel">
    <div id="meta">Laddar‚Ä¶</div>
    <div id="drink-list"></div>
  </section>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h2 id="modal-title" class="modal-title"></h2>
        <span id="modal-close" class="close" aria-label="St√§ng">&times;</span>
      </div>
      <div class="grid-2">
        <div>
          <div style="color:#6B7280">Ingredienser</div>
          <ul id="modal-ingredients"></ul>
        </div>
        <div>
          <div style="color:#6B7280">Instruktion</div>
          <p id="modal-instruction"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function init(){
      const meta = document.getElementById('meta');
      const listEl = document.getElementById('drink-list');
      const groupSelect = document.getElementById('group-by');

      let drinks = [], relations = [];
      try{
        const resp = await fetch('drinkkompassen_full.json', { cache:'no-store' });
        const data = await resp.json();
        drinks = data.drinks; relations = data.relations;
        meta.textContent = `Antal drinkar: ${drinks.length}`;
      }catch(err){
        meta.textContent = `Kunde inte ladda data: ${err.message}`;
        console.error(err); return;
      }

      const fuse = new Fuse(drinks, { keys:['namn','ingredienser'], threshold:0.28 });

      const nodes = new vis.DataSet();
      const edges = new vis.DataSet();
      const container = document.getElementById('graph');
      const net = new vis.Network(container, { nodes, edges }, {
        layout: { improvedLayout: true },
        physics: {
          enabled: true,
          solver: 'repulsion', // robust mot √∂verlapp
          repulsion: { nodeDistance: 260, springLength: 180, springConstant: 0.045, damping: 0.11, centralGravity: 0.12 },
          stabilization: { enabled: true, iterations: 700, updateInterval: 25, fit: true },
          minVelocity: 0.75
        },
        interaction: { dragNodes:true, dragView:true, hover:true, tooltipDelay:140, zoomView:true },
        nodes: {
          shape:'box', margin:8,
          font:{ size:16, color:'#fff', face:'Inter' },
          color:{ background:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() },
          shapeProperties:{ borderRadius: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--radius')) || 12 }
        },
        edges: {
          arrows:'to',
          color:{ color:getComputedStyle(document.documentElement).getPropertyValue('--edge').trim(),
                  highlight:getComputedStyle(document.documentElement).getPropertyValue('--edge-hi').trim() },
          smooth:{ type:'dynamic' },
          font:{ size:12, face:'Inter' }
        }
      });

      const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      const highlight = getComputedStyle(document.documentElement).getPropertyValue('--highlight').trim();
      net.on('hoverNode', p => {
        const id = p.node, conn = new Set(net.getConnectedNodes(id).concat(id)), eids = net.getConnectedEdges(id);
        nodes.forEach(n => nodes.update({ id:n.id, color:{ background: conn.has(n.id)? highlight : accent } }));
        eids.forEach(eid => edges.update({ id:eid, color:{ color:getComputedStyle(document.documentElement).getPropertyValue('--edge-hi').trim() } }));
      });
      net.on('blurNode', () => {
        nodes.forEach(n => nodes.update({ id:n.id, color:{ background: accent } }));
        edges.forEach(e => edges.update({ id:e.id, color:{ color:getComputedStyle(document.documentElement).getPropertyValue('--edge').trim() } }));
      });

      function showRecipe(d){
        document.getElementById('modal-title').textContent = d.namn;
        const ul = document.getElementById('modal-ingredients'); ul.innerHTML='';
        d.ingredienser.forEach(i => { const li=document.createElement('li'); li.textContent=i; ul.appendChild(li); });
        document.getElementById('modal-instruction').textContent = d.instruktion || '';
        document.getElementById('modal').style.display = 'block';
      }
      document.getElementById('modal-close').onclick = () => document.getElementById('modal').style.display = 'none';
      document.getElementById('modal').addEventListener('click', e => { if(e.target.id==='modal') e.currentTarget.style.display='none'; });
      net.on('click', p => { if(p.nodes.length){ const d = drinks.find(x=>x.namn===p.nodes[0]); if(d) showRecipe(d); } });

      function setData(arr){
        nodes.clear(); edges.clear();
        arr.forEach(d => nodes.add({ id:d.namn, label:d.namn }));
        relations.filter(r => arr.some(x=>x.namn===r.from) && arr.some(x=>x.namn===r.to))
                 .forEach(r => edges.add({ from:r.from, to:r.to, label:r.label }));
      }

      // ---- Klustrad seed-positionering ----
      function uniqueValues(arr, key){
        const s = new Set(arr.map(d => d[key]).filter(Boolean));
        return Array.from(s);
      }
      function polarToXY(R, angleDeg){
        const a = angleDeg * Math.PI/180;
        return { x: R * Math.cos(a), y: R * Math.sin(a) };
      }
      function seedPositions(arr, byKey){
        const groups = uniqueValues(arr, byKey);
        const nG = groups.length || 1;
        const R = 400; // radie f√∂r gruppcentra
        const jitter = 60; // spridning inom gruppen
        const centers = {};
        // L√§gg ut grupper runt en cirkel f√∂r att minska korsningar mellan block
        groups.forEach((g, i) => {
          const angle = (360 / nG) * i;
          centers[g] = polarToXY(R, angle);
        });
        // Om bara en grupp: l√§gg i grid
        if(nG === 1){
          centers[groups[0]] = { x: 0, y: 0 };
        }
        const updates = [];
        arr.forEach((d, idx) => {
          const c = centers[d[byKey]] || { x: 0, y: 0 };
          const jx = (Math.random()*2 - 1) * jitter;
          const jy = (Math.random()*2 - 1) * jitter;
          updates.push({ id:d.namn, x: c.x + jx, y: c.y + jy, fixed:false });
        });
        if(updates.length) nodes.update(updates);
      }

      function render(arr){
        setData(arr);
        // Sl√• p√• fysik f√∂r att l√•ta n√§tet ‚Äús√§tta sig‚Äù
        net.setOptions({ physics: { enabled:true } });
        // Seed enligt vald klustring
        const key = groupSelect.value; // 'kategori' eller 'sprit'
        seedPositions(arr, key);
        // Stabilize, sedan st√§ng av fysik (still dragbart)
        net.stabilize();
        net.once('stabilizationIterationsDone', ()=>{
          net.setOptions({ physics:false });
        });
        // Lista
        listEl.innerHTML='';
        arr.forEach(d => {
          const row = document.createElement('div');
          row.className = 'drink-item';
          row.textContent = d.namn;
          row.onclick = () => showRecipe(d);
          listEl.appendChild(row);
        });
      }

      // S√∂k
      const search = document.getElementById('search');
      search.addEventListener('input', () => {
        const q = search.value.trim();
        const res = q ? fuse.search(q).map(r=>r.item) : drinks;
        render(res);
      });

      // Anv√§nd layout / √Öterst√§ll
      document.getElementById('apply').onclick = () => {
        const q = search.value.trim();
        const res = q ? fuse.search(q).map(r=>r.item) : drinks;
        render(res);
      };
      document.getElementById('reset').onclick = () => {
        search.value = '';
        render(drinks);
      };

      // Init
      render(drinks);
    }
    init();
  </script>
</body>
</html>
